{% extends "generic.html" %}

{% block custom_headers %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
    function makeSearchFilter(selectValues) {
        let filters = $('.search-filter')
        let selectID;
        if (filters.length > 0) {
            selectID = Math.max(...filters.map(function () { return this.id.slice(14) })) + 1;
        } else {
            selectID = 1;
        }
        console.log("selectID: " + selectID);
        htmlBuilder = `<div class="form-group search-filter search-filter-${selectID}" id="search-filter-${selectID}">`
        let selectHeader = `<select name="resultFilter_${selectID}" class="form-control search-selector search-filter-select search-filter-${selectID}" required="" id="resultFilter_${selectID}">`
        htmlBuilder += selectHeader;
        // console.log(typeof selectedValues);
        let fields = Object.entries(selectValues);
        for (let i = 0; i < fields.length ; i++) {
            htmlBuilder += `<option value="${fields[i][0]}">${fields[i][1]}</option>`
        }
        htmlBuilder += `<input type="text" class="form-control search-filter-text search-filter-${selectID}" id="resultfiltervalue_${selectID}" name="resultFilterValue_${selectID}">`
        htmlBuilder += "</select></div>";
        htmlBuilder += `<div class="form-group"><button type="button" class="btn btn-default search-filter-append">AND</button></div>`;
        return htmlBuilder;
    }

    function addSearchFilter(actionSuccess) {
        let resultTypeSelector = $("#resultTypeSelector")[0];
        let resultType = resultTypeSelector.options[resultTypeSelector.options.selectedIndex].value;
        $.post("/ajax_calls/search_selector", {
            'csrfmiddlewaretoken': '{{ csrf_token }}',
            'resultType': resultType
        }, function (data) {
            $("#search-bar-body").append(makeSearchFilter(data.fields));
        });
    }

    function resetSearchFilters() {
        $("#search-bar-body").empty();
        addSearchFilter();
    }

    function logPressed() {
        console.log("pressed");
    }

    $(document).ready(function () {
        addSearchFilter();
    });
    $(document).ready(function () {
        $("#resultTypeSelector").on("change", resetSearchFilters);
    });
    $(document).ready(function () {
        $("#search-bar-body").on("click", ".search-filter-append", addSearchFilter);
    });
</script>

{% endblock %}

{% block page_name %}
<h3>Search</h3>
{% endblock page_name %}

{% block content %}
<form id="search" method="GET" action="">
    <div id="search-bar" name="Search Bar" class='row'>
        <div class="form-group">
            <select name="resultType" class="form-control search-selector" required="" id="resultTypeSelector">
                {% for resultType in resultTypes %}
                <option class="form-control" value="{{ resultType }}">{{ resultType }}</option>
                {% endfor %}
            </select>
            <div name="search-bar-body" id="search-bar-body">

            </div>
        </div>
    </div>
    <div class="form-group">
        <button type="submit" class="btn btn-default btn-submit">Submit</button>
    </div>
</form>
<!-- <button class="btn" id="actionbutton">Press me!</button> -->
<!-- <div id="buttonresult">intial value</div> -->
{% for object in object_list %}
<div class='row'>
    <div class='col-12'>
        result: <a href='{{ object.get_absolute_url }}'>{{ object }}</a>
    </div>
</div>
{% endfor %}
<p>fields: {{ fields }}</p>
<h3>Get Params</h3>
{{ getParams }}
<h3>Post Params</h3>
{{ postParams }}
{% endblock %}