{% extends "base.html" %}
{% load static %}


{% block custom_headers %}
<!-- <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script> -->
<script>

    function getResultType() {
        let resultTypeSelector = $("#search-result-type-selector")[0];
        return resultTypeSelector.options[resultTypeSelector.options.selectedIndex].value;
    }

    const foreignKeyNames = ['series', 'location'];

    function addSearchFilter(element) {
        let resultType = getResultType();
        $.get("{% url 'catalogue:make_search_filter' %}", {
            'resultType': resultType,
        }, function (data) {
            $(element).append(data);
            $('.search-filter-main-select').select2();
            $('.search-filter-foreignkey-select').select2();
        });
    }

    function resetSearchFilters() {
        $("#search-filters-container").empty();
        addSearchFilter("#search-filters-container");
    }

    function makeSearchQuery() {
        let resultType = getResultType();
        let filters = [];

        let filtersList = $(".search-filter");
        for (let i = 0; i < filtersList.length; i++) {
            let searchFilter = filtersList.eq(i);
            let mainSelect = searchFilter.find(".search-filter-main-select")[0];
            let foreignSelect = searchFilter.find(".search-filter-foreignkey-select")[0];
            let filterText = searchFilter.find(".search-filter-text")[0];

            let fieldName = mainSelect.options[mainSelect.options.selectedIndex].value;
            let foreignKeyField;

            if (foreignSelect) {
                foreignKeyField = foreignSelect.value;
            } else if (fieldName === "series") { // this is so if series is first option opened still have foreignKeyField value - should be cleaned up
                foreignKeyField = "name"
            }

            filters.push({
                "fieldName": fieldName,
                "fieldValue": filterText.value,
                "foreignKeyField": foreignKeyField
            })
        }
        return { "resultType": resultType, "filters": filters }
    }


    $(document).ready(function () {

        // initialize select2
        $('#search-result-type-selector').select2();
        $('.search-filter-main-select').select2();
        $('.search-filter-foreignkey-select').select2();

        // add filters on click
        $("#add-search-filter-button").on("click", () => { addSearchFilter("#search-filters-container") });

        // add/remove foreignkey filter on change in main select
        $("#search-filters-container").on("change", ".search-filter-main-select", (event) => {
            $(event.target).parent().parent().children('.search-filter-foreignkey-select-wrapper').remove();
            let newFilterValue = event.target.options[event.target.options.selectedIndex].value;
            if (foreignKeyNames.includes(newFilterValue)) {
                let newFilterResultType = newFilterValue.charAt(0).toUpperCase() + newFilterValue.slice(1);
                $.get("{% url 'catalogue:make_search_filter_foreignkey' %}", {
                    'resultType': newFilterResultType,
                }, function (data) {
                    $(data).insertAfter($(event.target).parent());
                    $('.search-filter-main-select').select2();
                    $('.search-filter-foreignkey-select').select2();
                });
            }
        })

        // reset filters on resultType change
        $("#search-result-type-selector").on("change", resetSearchFilters);

        // delete specific filter when its remove button is pressed
        $("#search-bar-container").on("click", ".search-filter-remove", (event) => {
            $(event.target).parent().parent().remove();
        });

        // send filter data on submit in JSON serialized string
        $("#search-form").submit(() => {
            let query = makeSearchQuery();
            $('<input />').attr('type', 'hidden')
                .attr('name', 'data')
                .attr('value', JSON.stringify(query))
                .appendTo("#search-form");
            return true;
        });
    });


    /*
    redesign is happening here

    1. make search bar a box, with select type on left (inline select) - V
    2. give submit button on right of search bar - V
    3. add a + button in search bar - V
    4. make+add select after button press - v
    6. add cancel button to select - v
    7. remove select after button pressed - v
    8. pop up extra box for foreignkey - v
    9. reload filter data after submit - v

    4. get list of all filter fields for all types to start (have visible and invisible values for each) - v
    5. if + button pressed, create html box in search bar, with select for appropriate field types, text input, and little x button - v
    6. if x button pressed, remove text box - v
    7. if resultType changed, remove all boxes - v
    8. define onsubmit action (put together appropriate data structure for SearchView) - v
    9. if foreignkey, pop up extra box - v
    10. keep track of field types, and only show field types not active in new boxes - not gonna do that now
    11. change history to allow back arrow + reload
    12. delete with backspace - stretch goal
    */

</script>

{% endblock %}

{% block page_title %}Search{% endblock %}

{% block content %}
<div class="row">
    <div class="form flex-container" name="search-bar-container" id="search-bar-container">
        <div class="form-group">
            <select class="form-control" name="resultType" id="search-result-type-selector">
                {% for model in modelsToSearch %}
                <option class="form-control" value="{{ model }}" {% if model == selectedModel %}selected{% endif %}>
                    {{ model }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group flex-container" id="search-bar-main-body">
            <!-- I want this wider, and I shouldn't have to nest flex containers inside each other -->
            <div class="form-control flex-container" name="search-filters-container" id="search-filters-container">
                {% include "./search_bar.html" with filters=filters foreignKeyFields=foreignKeyFields fields=fields%}
            </div>
            <button type="button" class="btn" id="add-search-filter-button">+</button>
        </div>
        <form method="POST" action="" id="search-form" name="search-form">
            <div class="form-group">
                <button type="submit" class="btn btn-default btn-submit" id="search-bar-submit">Search</button>


                </div>
            {% csrf_token %}
        </form>
    </div>
</div>
<div class="row">
    <a href="{{ createLink }}" class="btn btn-primary">Create new</a>
</div>
{% if selectedModel == "Artwork" %}
<div class="row">
    <!-- Rules: create a wrapper that is min width 3 images wide (including padding) and as high as we need. 
        Set it to be centered within main page, and have whiespace on both sides if it exceeds this max width.
        if screen narrower than this minimum width - have the main page screen scrollable left right.
    Within that, have a flex container for the images, justified to start.
    images have to be 293 pixels to a side - it's ok to cut the top right corner of the images for this.
    On top of images, have a div with the image data. set it to transparency 100%, except if you mouse over it set transparency to 10% or so  -->
    <div id="search-results-wrapper" class="mx-auto">
        <div id="searchResults" style="display:flex;justify-content:flex-start;flex-wrap:wrap;width:999px;">

            {% for artwork in object_list %}
            <div class="gallery-item-wrapper" style="height:293px;width:293px;margin:20px">
                <img class="img-fluid" style="height:293px;width:293px;overflow:hidden;" src="{{ artwork.image.url }}"
                    alt="Artwork image">
                <!-- <div class="gallery-item-image" style="background-image:url('{{artwork.image.url}}');"> -->
                <div class="gallery-item-text">
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
<!-- <div class="gallery-item-container visible clickable" id="pgi81f0ce72708b4869b2a3bfd27dce86c2_0" tabindex="0"
                        aria-label="Diptych | Private Residence" data-hash="81f0ce72-708b-4869-b2a3-bfd27dce86c2"
                        data-id="81f0ce72-708b-4869-b2a3-bfd27dce86c2" data-idx="0" role="button" data-hook="item-container"
                        style="overflow-y:hidden;position:absolute;bottom:auto;margin:0;overflow:hidden;border-radius:0;border-width:0px">
                        <div>
                            <div data-hook="item-wrapper" class="gallery-item-wrapper visible cube-type-fill"
                            style="background-color:none;height:293px;margin:0px;width:293px">
                            <div class="gallery-item-content image-item gallery-item-visible gallery-item gallery-item-preloaded  "
                            data-hook="image-item" style=""><canvas
                        class="gallery-item-visible gallery-item gallery-item-hidden gallery-item-preloaded" role="img"
                        alt="Diptych | Private Residence"
                        data-src="https://static.wixstatic.com/media/12d850_48dc5154f3ac42ea86385de8f7aa26ea~mv2.jpg/v1/fill/w_293,h_293,fp_0.50_0.50,q_90/12d850_48dc5154f3ac42ea86385de8f7aa26ea~mv2.jpg"
                        style="width:293px;height:293px"></canvas></div>
                <div class="gallery-item-hover fullscreen-enabled" data-hook="item-hover-0" aria-hidden="true">
                    <div
                        style="display:flex;flex-direction:column;height:100%;justify-content:center;box-sizing:border-box;padding-left:0px;padding-right:0px;padding-top:0px;padding-bottom:0px">
                        <div style="justify-content:center;align-items:center;text-align:center;padding-bottom:70px"
                            class="gallery-item-text" dir="auto">
                            <div class="gallery-item-title" data-hook="item-title"
                                style="margin-bottom: 6px; visibility: visible; display: -webkit-box; overflow: hidden; -webkit-line-clamp: none;">
                                <span>Diptych | Private Residence</span></div>
                            <div class="gallery-item-description" data-hook="item-description"
                                style="margin-bottom: 0px; visibility: visible; display: -webkit-box; overflow: hidden; -webkit-line-clamp: 6;">
                                <span>2010 | 63x158in | 160x400cm<br></span></div>
                        </div>
                        <div class="gallery-item-social gallery-item-direction-center vertical-item populated-item"
                            data-hook="item-social">
                            <div class="block-fullscreen gallery-item-social-share gallery-item-social-button"
                                data-hook="gallery-item-social-button"><i
                                    class="block-fullscreen progallery-svg-font-icons-share-store"></i></div>
                        </div>
                        <div data-hook="social-share-box"
                            class="block-fullscreen gallery-item-social-share-box  hidden  vertical-item "
                            style="transform:translateY(-50%)" tabindex="-1" aria-label="Share" role="button"><button
                                class="block-fullscreen has-custom-focus network-1 progallery-svg-font-icons-facebook"
                                style="top:calc(100% / 6 * 1 + -10px );left:" data-hook="facebook-share-button"
                                title="Share on facebook" aria-live="assertive" tabindex="-1"></button><button
                                class="block-fullscreen has-custom-focus network-2 progallery-svg-font-icons-twitter"
                                style="top:calc(100% / 6 * 2 + -10px );left:" data-hook="twitter-share-button"
                                title="Share on twitter" aria-live="assertive" tabindex="-1"></button><button
                                class="block-fullscreen has-custom-focus network-3 progallery-svg-font-icons-pinterest"
                                style="top:calc(100% / 6 * 3 + -10px );left:" data-hook="pinterest-share-button"
                                title="Share on pinterest" aria-live="assertive" tabindex="-1"></button><button
                                class="block-fullscreen has-custom-focus network-4 progallery-svg-font-icons-tumblr"
                                style="top:calc(100% / 6 * 4 + -10px );left:" data-hook="tumblr-share-button"
                                title="Share on tumblr" aria-live="assertive" tabindex="-1"></button><button
                                class="block-fullscreen has-custom-focus network-5 progallery-svg-font-icons-email"
                                style="top:calc(100% / 6 * 5 + -10px );left:" data-hook="email-share-button"
                                title="Share on email" aria-live="assertive" tabindex="-1"></button></div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
<div class="row">
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="searchResults">
            {% if selectedModel == "Series" %}
            {% include "./series_list.html" with object_list=object_list %}
            {% elif selectedModel == "Location" %}
            {% include "./location_list.html" with object_list=object_list %}
            {% elif selectedModel == "Exhibition" %}
            {% include "./exhibition_list.html" with object_list=object_list %}
            {% else %}
            {% include "./artwork_list.html" with object_list=object_list %}
            {% endif %}
        </table>
    </div>
</div>

{% endblock %}