{% extends "base.html" %}
{% load static %}


{% block custom_headers %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
    function makeSearchFilter(selectValues) {
        let filters = $('.search-filter')
        let selectID;
        if (filters.length > 0) {
            selectID = Math.max(...filters.map(function () { return this.id.slice(14) })) + 1;
        } else {
            selectID = 1;
        }
        console.log("selectID: " + selectID);
        htmlBuilder = `<div class="form-group search-filter search-filter-${selectID}" id="search-filter-${selectID}">`
        let selectHeader = `<select name="resultFilter_${selectID}" class="form-control search-selector search-filter-select search-filter-${selectID}" required="" id="resultFilter_${selectID}">`
        htmlBuilder += selectHeader;
        // console.log(typeof selectedValues);
        let fields = Object.entries(selectValues);
        for (let i = 0; i < fields.length; i++) {
            htmlBuilder += `<option value="${fields[i][0]}">${fields[i][1]}</option>`
        }
        htmlBuilder += `<input type="text" class="form-control search-filter-text search-filter-${selectID}" id="resultfiltervalue_${selectID}" name="resultFilterValue_${selectID}">`
        htmlBuilder += "</select></div>";
        htmlBuilder += `<div class="form-group"><button type="button" class="btn btn-default search-filter-append">AND</button></div>`;
        return htmlBuilder;
    }

    function getFilterCount() {
        let filters = $('.search-filter')
        let filterCount;
        if (filters.length > 0) {
            filterCount = Math.max(...filters.map(function () { return this.id.slice(14) })) + 1;
        } else {
            filterCount = 1;
        }
        return filterCount;
    }

    function addSearchFilter(element) {
        let filterCount = getFilterCount();
        let resultTypeSelector = $("#resultTypeSelector")[0];
        let resultType = resultTypeSelector.options[resultTypeSelector.options.selectedIndex].value;
        $.get("c/searchbar", {
            // 'resultType': resultType
            'resultType': resultType,
            'count': filterCount
        }, function (data) {
            $(element).append(data);
        });
    }

    function fillSearchFilters(params) {
        $.get("c/searchbar",
            $.param(params),
            function (data) {
                $("#search-bar-body").append(data);
            });
    }

    function resetSearchFilters() {
        $("#search-bar-body").empty();
        addSearchFilter("#search-bar-body");
    }

    function logPressed() {
        console.log("pressed");
    }

    function getQueryParams() {
        let search = window.location.search.substring(1);
        let params;
        if (search) {
            params = JSON.parse('{"' + search.replace(/&/g, '","').replace(/=/g, '":"') + '"}', function (key, value) { return key === "" ? value : decodeURIComponent(value) });
        } else {
            params = null;
        }
        return params;
    }

    $(document).ready(function () {
        console.log(getQueryParams());
        fillSearchFilters(getQueryParams());
        // addSearchFilter();
    });
    $(document).ready(function () {
        $("#resultTypeSelector").on("change", resetSearchFilters);
    });
    $(document).ready(function () {
        addSearchFilter("#search-filters-container");
        $("#search-bar-body").on("click", ".search-filter-append", () => { addSearchFilter("#search-bar-body") });
        $("#add-search-filter-button").on("click", () => { addSearchFilter("#search-filters-container") });
        $("#search-result-type-selector").on("change", () => {
            $("#search-filters-container").empty();
            addSearchFilter("#search-filters-container");
        })
    });
    /*
    redesign is happening here

    1. make search bar a box, with select type on left (inline select) - V
    2. give submit button on right of search bar - V
    3. add a + button in search bar - V
    4. get list of all filter fields for all types to start (have visible and invisible values for each)
    5. if + button pressed, create html box in search bar, with select for appropriate field types, text input, and little x button
    6. if x button pressed, remove text box
    7. if resultType changed, remove all boxes
    8. define onsubmit action (put together appropriate data structure for SearchView)
    9. if foreignkey, pop up extra box
    10. keep track of field types, and only show field types not active in new boxes
    11. delete with backspace - stretch goal
    */

</script>

{% endblock %}

{% block page_title %}Search{% endblock %}

{% block content %}
<form id="search" method="GET" action="" class="form-inline">
    <div id="search-bar" name="Search Bar" class='input-group'>
        <div class="col-xs-2 form-group">
            <select name="resultType" class="form-control search-selector" required="" id="resultTypeSelector">
                {% for resultType in resultTypes %}
                <option class="form-control" value="{{ resultType }}"
                    {% if resultType == selectedModel %}selected{% endif %}>
                    {{ resultType }}</option>
                {% endfor %}
            </select>
        </div>
        <div name="search-bar-body" id="search-bar-body" class="col-xs-10 form-group form-control flex-container">
        </div>
    </div>
    <div class="form-group">
        <button type="submit" class="btn btn-default btn-submit">Submit</button>
    </div>
</form>
<p> something else

    <div class="row">
        <form method="POST" action="" class="form flex-container col-xs-10" name="search-bar-container"
            id="search-bar-container">
            <div class="form-group">
                <select class="form-control" name="resultTypeSelector" id="search-result-type-selector">
                    {% for model in modelsToSearch %}
                    <option class="form-control" value="{{ model }}"
                        {% if resultType == selectedModel %}selected{% endif %}>
                        {{ model }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group flex-container" name="search-bar-main-body">
                <!-- I want this wider, and I shouldn't have to nest flex containers inside each other -->
                <div class="form-control flex-container" name="search-filters-container" id="search-filters-container">

                </div>
                <button type="button" class="btn" id="add-search-filter-button">+</button>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-default btn-submit" id="search-bar-submit">Search</button>


            </div>
            {% csrf_token %}
        </form>
    </div>

    <div class="row">
        <div class="table-responsive">
            <table class=table>
                {% if selectedModel == "Series" %}
                <tr>
                    <th>Name</th>
                </tr>
                {% for series in object_list %}
                <tr>
                    <td><a href="{% url 'catalogue:series_detail' series.pk %}">{{ series.name }}</a></td>
                </tr>
                {% endfor %}
                {% elif selectedModel == "Exhibition" %}
                <tr>
                    <th>Name</th>
                    <th>Start date</th>
                    <th>End date</th>
                </tr>
                {% for exhibition in object_list %}
                <tr>
                    <td><a href="{% url 'catalogue:exhibition_detail' exhibition.pk %}">{{ exhibition.name }}</a></td>
                    <td>{{ exhibition.start_date }}</td>
                    <td>{{ exhibition.end_date }}</td>
                </tr>
                {% endfor %}
                {% elif selectedModel == "Location" %}
                <tr>
                    <th>Name</th>
                    <th>City</th>
                    <th>Country</th>
                </tr>
                {% for location in object_list %}
                <tr>
                    <td><a href="{% url 'catalogue:location_detail' location.pk %}">{{ location.name }}</a></td>
                    <td>{{ location.city }}</td>
                    <td>{{ location.country }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <th></th>
                    <th>Series</th>
                    <th>Title</th>
                    <th>Location</th>
                    <th>Size</th>
                </tr>
                {% for artwork in object_list %}
                <tr>
                    <td>
                        <a href="{% url 'catalogue:artwork_detail' artwork.pk %}">
                            {% if artwork.image %}
                            <img class="img-fluid" style="width: 80px; object-fit: contain;"
                                src="{{ artwork.image.url }}" alt="Artwork image">
                            {% else %}
                            <img class="img-fluid" style="width: 80px; object-fit: contain;"
                                src="{% static 'catalogue/images/unicorn.png' %}" alt="Artwork image">
                            {% endif %}
                        </a>
                    </td>
                    <td><a href="{% url 'catalogue:series_detail' artwork.series.pk %}">{{ artwork.series }}</a></td>
                    <td><a href="{% url 'catalogue:artwork_detail' artwork.pk %}">{{ artwork.title }}</a></td>
                    <td><a href="{% url 'catalogue:location_detail' artwork.location.pk %}">{{ artwork.location }}</a>
                    </td>
                    <td>{{ artwork.size }}</td>
                </tr>
                {% endfor %}
                {% endif %}
            </table>
        </div>
    </div>
    <p>selectedModel: {{ selectedModel }}</p>
    <h3>Get Params</h3>
    {{ getParams }}
    <h3>Post Params</h3>
    {{ postParams }}
    {% endblock %}